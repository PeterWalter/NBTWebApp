@page "/admin/announcements"
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))
@inject IAnnouncementService AnnouncementService
@inject NavigationManager NavigationManager

<PageTitle>Announcements - Admin</PageTitle>

<div style="padding: 24px;">
    <FluentStack Orientation="Orientation.Vertical" Style="gap: 24px;">
        <FluentStack HorizontalAlignment="HorizontalAlignment.SpaceBetween">
            <div>
                <h1>Announcements</h1>
                <p style="color: var(--neutral-foreground-hint);">Manage news and announcements</p>
            </div>
            <FluentButton Appearance="Appearance.Accent" OnClick="@ShowCreateDialog">
                + New Announcement
            </FluentButton>
        </FluentStack>

        @if (isLoading)
        {
            <FluentProgressRing />
        }
        else if (errorMessage != null)
        {
            <FluentMessageBar Intent="MessageIntent.Error">
                @errorMessage
            </FluentMessageBar>
        }
        else if (announcements == null || !announcements.Any())
        {
            <FluentCard>
                <FluentMessageBar Intent="MessageIntent.Info">
                    No announcements yet. Click "New Announcement" to create one.
                </FluentMessageBar>
            </FluentCard>
        }
        else
        {
            <FluentCard>
                <FluentDataGrid Items="@announcements.AsQueryable()" Style="width: 100%;">
                    <PropertyColumn Property="@(a => a.Title)" Title="Title" Sortable="true" />
                    <PropertyColumn Property="@(a => a.Category)" Title="Category" Sortable="true" />
                    <PropertyColumn Property="@(a => a.PublicationDate)" Title="Published" Format="d" Sortable="true" />
                    <TemplateColumn Title="Featured">
                        @if (context.IsFeatured)
                        {
                            <span style="color: gold;">⭐</span>
                        }
                    </TemplateColumn>
                    <TemplateColumn Title="Actions">
                        <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => ShowEditDialog(context))">
                            Edit
                        </FluentButton>
                        <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => ToggleFeatured(context))">
                            @(context.IsFeatured ? "Unfeature" : "Feature")
                        </FluentButton>
                        <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => ShowDeleteDialog(context))">
                            Delete
                        </FluentButton>
                    </TemplateColumn>
                </FluentDataGrid>
            </FluentCard>
        }

        <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => NavigationManager.NavigateTo("/admin"))">
            ← Back to Dashboard
        </FluentButton>
    </FluentStack>
</div>

<!-- Create/Edit Dialog -->
<FluentDialog @bind-Hidden="@hideEditDialog" Modal="true" Style="width: 600px; max-width: 90vw;">
    <FluentDialogHeader>
        <h3>@(isEditMode ? "Edit Announcement" : "New Announcement")</h3>
    </FluentDialogHeader>
    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical" Style="gap: 16px;">
            <FluentTextField @bind-Value="@currentTitle" Label="Title" Required Style="width: 100%;" />
            
            <FluentTextField @bind-Value="@currentSummary" Label="Summary" Required Style="width: 100%;" />
            
            <FluentTextArea @bind-Value="@currentFullContent" Label="Full Content" Required Rows="10" Style="width: 100%;" />
            
            <FluentSelect TOption="string" @bind-Value="@selectedCategory" Label="Category" Style="width: 100%;">
                <FluentOption Value="@(((int)AnnouncementCategory.PolicyUpdate).ToString())">Policy Update</FluentOption>
                <FluentOption Value="@(((int)AnnouncementCategory.TestDates).ToString())">Test Dates</FluentOption>
                <FluentOption Value="@(((int)AnnouncementCategory.FeeChanges).ToString())">Fee Changes</FluentOption>
                <FluentOption Value="@(((int)AnnouncementCategory.GeneralNews).ToString())">General News</FluentOption>
            </FluentSelect>
            
            <FluentDatePicker @bind-Value="@publicationDate" Label="Publication Date" Style="width: 100%;" />
            
            <FluentCheckbox @bind-Value="@currentIsFeatured" Label="Feature this announcement" />
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => hideEditDialog = true)">
            Cancel
        </FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="@SaveAnnouncement">
            @(isEditMode ? "Update" : "Create")
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Delete Confirmation Dialog -->
<FluentDialog @bind-Hidden="@hideDeleteDialog" Modal="true">
    <FluentDialogHeader>
        <h3>Confirm Delete</h3>
    </FluentDialogHeader>
    <FluentDialogBody>
        <p>Are you sure you want to delete "<strong>@selectedAnnouncement?.Title</strong>"?</p>
        <p style="color: var(--error-foreground-rest);">This action cannot be undone.</p>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => hideDeleteDialog = true)">
            Cancel
        </FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="@ConfirmDelete">
            Delete
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private List<AnnouncementDto> announcements = new();
    
    private bool hideEditDialog = true;
    private bool hideDeleteDialog = true;
    private bool isEditMode = false;
    private Guid currentId;
    private string currentTitle = string.Empty;
    private string currentSummary = string.Empty;
    private string currentFullContent = string.Empty;
    private string selectedCategory = "4"; // GeneralNews
    private bool currentIsFeatured = false;
    private AnnouncementDto? selectedAnnouncement;
    private DateTime? publicationDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            announcements = await AnnouncementService.GetAllAnnouncementsAsync() ?? new List<AnnouncementDto>();
            announcements = announcements.OrderByDescending(a => a.PublicationDate).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading announcements: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowCreateDialog()
    {
        isEditMode = false;
        currentId = Guid.Empty;
        currentTitle = string.Empty;
        currentSummary = string.Empty;
        currentFullContent = string.Empty;
        selectedCategory = "4"; // GeneralNews
        currentIsFeatured = false;
        publicationDate = DateTime.Today;
        hideEditDialog = false;
    }

    private void ShowEditDialog(AnnouncementDto announcement)
    {
        isEditMode = true;
        currentId = announcement.Id;
        currentTitle = announcement.Title;
        currentSummary = announcement.Summary;
        currentFullContent = announcement.FullContent;
        selectedCategory = ((int)announcement.Category).ToString();
        currentIsFeatured = announcement.IsFeatured;
        publicationDate = announcement.PublicationDate;
        hideEditDialog = false;
    }

    private async Task SaveAnnouncement()
    {
        try
        {
            if (isEditMode)
            {
                var updateDto = new UpdateAnnouncementDto
                {
                    Title = currentTitle,
                    Summary = currentSummary,
                    FullContent = currentFullContent,
                    Category = (AnnouncementCategory)int.Parse(selectedCategory),
                    IsFeatured = currentIsFeatured,
                    Status = "Published"
                };
                await AnnouncementService.UpdateAnnouncementAsync(currentId, updateDto);
            }
            else
            {
                var createDto = new CreateAnnouncementDto
                {
                    Title = currentTitle,
                    Summary = currentSummary,
                    FullContent = currentFullContent,
                    Category = (AnnouncementCategory)int.Parse(selectedCategory),
                    PublicationDate = publicationDate,
                    IsFeatured = currentIsFeatured,
                    Status = "Published"
                };
                await AnnouncementService.CreateAnnouncementAsync(createDto);
            }
            
            hideEditDialog = true;
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving announcement: {ex.Message}";
        }
    }

    private async Task ToggleFeatured(AnnouncementDto announcement)
    {
        try
        {
            var updateDto = new UpdateAnnouncementDto
            {
                Title = announcement.Title,
                Summary = announcement.Summary,
                FullContent = announcement.FullContent,
                Category = announcement.Category,
                IsFeatured = !announcement.IsFeatured,
                Status = announcement.Status
            };
            await AnnouncementService.UpdateAnnouncementAsync(announcement.Id, updateDto);
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating announcement: {ex.Message}";
        }
    }

    private void ShowDeleteDialog(AnnouncementDto announcement)
    {
        selectedAnnouncement = announcement;
        hideDeleteDialog = false;
    }

    private async Task ConfirmDelete()
    {
        if (selectedAnnouncement != null)
        {
            try
            {
                await AnnouncementService.DeleteAnnouncementAsync(selectedAnnouncement.Id);
                hideDeleteDialog = true;
                await LoadData();
            }
            catch (Exception ex)
            {
                errorMessage = $"Error deleting announcement: {ex.Message}";
            }
        }
    }
}
