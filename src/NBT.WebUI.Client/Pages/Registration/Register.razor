@page "/register"
@using NBT.WebUI.Client.Models
@using NBT.WebUI.Client.Services
@using Microsoft.FluentUI.AspNetCore.Components
@inject IRegistrationService RegistrationService
@inject NavigationManager Navigation

<PageTitle>Student Registration - NBT</PageTitle>

<div class="registration-container">
    <FluentCard class="wizard-card">
        <h1 class="wizard-title">
            <FluentIcon Value="@(new Icons.Regular.Size24.PersonAdd())" />
            Student Registration
        </h1>

        @if (!_registrationComplete)
        {
            <!-- Progress Stepper -->
            <FluentWizard @ref="_wizard"
                          @bind-Value="@_currentStepIndex" 
                          StepperPosition="StepperPosition.Top"
                          Height="auto"
                          DisplayStepNumber="true"
                          ButtonTemplate="@CustomButtonTemplate"
                          OnFinish="@HandleSubmitAsync">
                
                <!-- Step 1: Personal Information and Contact Details -->
                <FluentWizardStep Label="Personal & Contact" 
                                Summary="Identity and contact information"
                                OnChange="@OnStepChangeAsync">
                    <div class="step-content">
                        <h3>Personal Information & Contact Details</h3>
                        <p class="step-description">Please provide your identity and contact information</p>

                        <h4 style="margin-top: 0;">Identity Verification</h4>
                        <FluentSelect Label="ID Type *" 
                                    @bind-Value="_model.IDType"
                                    @bind-Value:after="StateHasChanged"
                                    TOption="string"
                                    Items="@_idTypes"
                                    OptionValue="@(x => x)"
                                    OptionText="@(x => GetIDTypeLabel(x))"
                                    Style="width: 100%; margin-bottom: 20px;" />

                        <FluentTextField Label="ID Number *" 
                                       @bind-Value="_model.IDNumber"
                                       @bind-Value:after="OnIDNumberChangedAsync"
                                       Style="width: 100%; margin-bottom: 20px;"
                                       Placeholder="@GetIDPlaceholder(_model.IDType)"
                                       Required="true" />
                        
                        @if (!string.IsNullOrEmpty(_idValidationMessage))
                        {
                            <FluentMessageBar Intent="@(_idValidationError ? MessageIntent.Error : MessageIntent.Success)"
                                            Style="margin-bottom: 20px;">
                                @_idValidationMessage
                            </FluentMessageBar>
                        }

                        @if (_model.IDType == "FOREIGN_ID" || _model.IDType == "PASSPORT")
                        {
                            <div class="form-row">
                                <FluentTextField Label="Nationality *" 
                                               @bind-Value="_model.Nationality"
                                               @bind-Value:after="StateHasChanged"
                                               Style="width: 100%;"
                                               Required="true" />
                                
                                <FluentTextField Label="Country of Origin *" 
                                               @bind-Value="_model.CountryOfOrigin"
                                               @bind-Value:after="StateHasChanged"
                                               Style="width: 100%;"
                                               Required="true" />
                            </div>
                        }

                        <h4 style="margin-top: 30px;">Personal Details</h4>
                        <div class="form-row">
                            <FluentTextField Label="First Name *" 
                                           @bind-Value="_model.FirstName"
                                           @bind-Value:after="StateHasChanged"
                                           Style="width: 100%;"
                                           Required="true" />
                            
                            <FluentTextField Label="Last Name *" 
                                           @bind-Value="_model.LastName"
                                           @bind-Value:after="StateHasChanged"
                                           Style="width: 100%;"
                                           Required="true" />
                        </div>

                        <div class="form-row">
                            <FluentDatePicker Label="Date of Birth *" 
                                            @bind-Value="_model.DateOfBirth"
                                            @bind-Value:after="StateHasChanged"
                                            Style="width: 100%;"
                                            Required="true"
                                            Max="@DateTime.Today.AddYears(-15)"
                                            Disabled="@_dobExtractedFromID" />
                            
                            <FluentSelect Label="Gender *" 
                                        @bind-Value="_model.Gender"
                                        @bind-Value:after="StateHasChanged"
                                        TOption="string"
                                        Items="@_genderOptions"
                                        OptionValue="@(x => x)"
                                        OptionText="@(x => x)"
                                        Style="width: 100%;"
                                        Required="true"
                                        Disabled="@_genderExtractedFromID" />
                        </div>

                        <FluentSelect Label="Ethnicity *" 
                                    @bind-Value="_model.Ethnicity"
                                    @bind-Value:after="StateHasChanged"
                                    TOption="string"
                                    Items="@_ethnicityOptions"
                                    OptionValue="@(x => x)"
                                    OptionText="@(x => x)"
                                    Style="width: 100%; margin-bottom: 30px;"
                                    Required="true" />

                        <h4>Contact Information</h4>
                        <FluentTextField Label="Email Address *" 
                                       @bind-Value="_model.Email"
                                       @bind-Value:after="StateHasChanged"
                                       Style="width: 100%; margin-bottom: 20px;"
                                       TextFieldType="TextFieldType.Email"
                                       Required="true"
                                       Placeholder="your.email@example.com" />

                        <div class="form-row">
                            <FluentTextField Label="Phone Number *" 
                                           @bind-Value="_model.PhoneNumber"
                                           @bind-Value:after="StateHasChanged"
                                           Style="width: 100%;"
                                           TextFieldType="TextFieldType.Tel"
                                           Required="true"
                                           Placeholder="0123456789" />
                            
                            <FluentTextField Label="Alternative Phone" 
                                           @bind-Value="_model.AlternativePhoneNumber"
                                           Style="width: 100%;"
                                           TextFieldType="TextFieldType.Tel"
                                           Placeholder="Optional" />
                        </div>

                        @if (!string.IsNullOrEmpty(_step1ValidationMessage))
                        {
                            <FluentMessageBar Intent="MessageIntent.Warning" Style="margin-top: 20px;">
                                @_step1ValidationMessage
                            </FluentMessageBar>
                        }
                    </div>
                </FluentWizardStep>

                <!-- Step 2: Academic Information and Survey Questions -->
                <FluentWizardStep Label="Academic & Survey" 
                                Summary="School details and background"
                                OnChange="@OnStepChangeAsync">

                    <div class="step-content">
                        <h3>Academic Information & Background Questionnaire</h3>
                        <p class="step-description">Please provide your academic background and help us understand your needs</p>

                        <h4 style="margin-top: 0;">Academic Details</h4>
                        <FluentTextField Label="School Name *" 
                                       @bind-Value="_model.SchoolName"
                                       @bind-Value:after="StateHasChanged"
                                       Style="width: 100%; margin-bottom: 20px;"
                                       Required="true" />

                        <div class="form-row">
                            <FluentSelect Label="School Province" 
                                        @bind-Value="_model.SchoolProvince"
                                        TOption="string"
                                        Items="@_provinces"
                                        OptionValue="@(x => x)"
                                        OptionText="@(x => x)"
                                        Style="width: 100%;" />
                            
                            <FluentNumberField Label="Current Grade" 
                                             @bind-Value="_model.GradeYear"
                                             Style="width: 100%;"
                                             Min="10"
                                             Max="12" />
                        </div>

                        <FluentTextField Label="Home Language" 
                                       @bind-Value="_model.HomeLanguage"
                                       Style="width: 100%; margin-bottom: 30px;"
                                       Placeholder="e.g., English, Afrikaans, Zulu" />

                        <h4>Pre-Test Questionnaire</h4>
                        <FluentTextArea Label="What motivates you to take the NBT?" 
                                      @bind-Value="_model.MotivationForTesting"
                                      Style="width: 100%; margin-bottom: 20px;"
                                      Rows="3"
                                      Placeholder="Share your reasons for taking this test" />

                        <FluentTextField Label="Career Interests" 
                                       @bind-Value="_model.CareerInterests"
                                       Style="width: 100%; margin-bottom: 20px;"
                                       Placeholder="What career field interests you?" />

                        <FluentTextField Label="Preferred Study Field" 
                                       @bind-Value="_model.PreferredStudyField"
                                       Style="width: 100%; margin-bottom: 20px;"
                                       Placeholder="What would you like to study at university?" />

                        <div class="form-row">
                            <FluentCheckbox @bind-Value="_model.HasAccessToComputer"
                                          Label="I have access to a computer"
                                          Style="width: 100%;" />
                            
                            <FluentCheckbox @bind-Value="_model.HasInternetAccess"
                                          Label="I have internet access at home"
                                          Style="width: 100%;" />
                        </div>

                        <FluentTextArea Label="Additional Comments" 
                                      @bind-Value="_model.AdditionalComments"
                                      Style="width: 100%; margin-top: 20px;"
                                      Rows="3"
                                      Placeholder="Any additional information you'd like to share (optional)" />

                        <h4 style="margin-top: 30px;">Residential Address (Optional)</h4>
                        <FluentTextField Label="Address Line 1" 
                                       @bind-Value="_model.AddressLine1"
                                       Style="width: 100%; margin-bottom: 20px;"
                                       Placeholder="Street address" />

                        <FluentTextField Label="Address Line 2" 
                                       @bind-Value="_model.AddressLine2"
                                       Style="width: 100%; margin-bottom: 20px;"
                                       Placeholder="Apartment, suite, etc. (optional)" />

                        <div class="form-row">
                            <FluentTextField Label="City" 
                                           @bind-Value="_model.City"
                                           Style="width: 100%;"
                                           Placeholder="City" />
                            
                            <FluentSelect Label="Province" 
                                        @bind-Value="_model.Province"
                                        TOption="string"
                                        Items="@_provinces"
                                        OptionValue="@(x => x)"
                                        OptionText="@(x => x)"
                                        Style="width: 100%;" />
                        </div>

                        <div class="form-row">
                            <FluentTextField Label="Postal Code" 
                                           @bind-Value="_model.PostalCode"
                                           Style="width: 100%;"
                                           Placeholder="0000" />
                            
                            <FluentTextField Label="Country" 
                                           @bind-Value="_model.Country"
                                           Style="width: 100%;" />
                        </div>

                        <h4 style="margin-top: 30px;">Special Accommodations</h4>
                        <FluentCheckbox @bind-Value="_model.RequiresAccommodation"
                                      @bind-Value:after="StateHasChanged"
                                      Label="I require special accommodations"
                                      Style="margin-bottom: 20px;" />

                        @if (_model.RequiresAccommodation)
                        {
                            <FluentTextArea Label="Accommodation Details *" 
                                          @bind-Value="_model.AccommodationDetails"
                                          @bind-Value:after="StateHasChanged"
                                          Style="width: 100%;"
                                          Rows="4"
                                          Placeholder="Please describe the accommodations you require (e.g., extra time, wheelchair access, braille materials)"
                                          Required="true" />
                            
                            <FluentMessageBar Intent="MessageIntent.Info" Style="margin-top: 10px;">
                                Your accommodation request will be reviewed by our team. You may be contacted for additional information.
                            </FluentMessageBar>
                        }

                        @if (!string.IsNullOrEmpty(_step2ValidationMessage))
                        {
                            <FluentMessageBar Intent="MessageIntent.Warning" Style="margin-top: 20px;">
                                @_step2ValidationMessage
                            </FluentMessageBar>
                        }
                    </div>
                </FluentWizardStep>

                <!-- Step 3: Review and Submit -->
                <FluentWizardStep Label="Review" Summary="Confirm your details"
                                OnChange="@OnStepChangeAsync">
                    <div class="step-content">
                        <h3>Review Your Information</h3>
                        <p class="step-description">Please review all information before submitting</p>

                        <div class="review-section">
                            <h4>Identity</h4>
                            <p><strong>ID Type:</strong> @GetIDTypeLabel(_model.IDType)</p>
                            <p><strong>ID Number:</strong> @_model.IDNumber</p>
                            @if (!string.IsNullOrEmpty(_model.Nationality))
                            {
                                <p><strong>Nationality:</strong> @_model.Nationality</p>
                            }
                        </div>

                        <div class="review-section">
                            <h4>Personal Information</h4>
                            <p><strong>Name:</strong> @_model.FirstName @_model.LastName</p>
                            <p><strong>Date of Birth:</strong> @_model.DateOfBirth?.ToString("dd MMM yyyy")</p>
                            <p><strong>Gender:</strong> @_model.Gender</p>
                            <p><strong>Ethnicity:</strong> @_model.Ethnicity</p>
                        </div>

                        <div class="review-section">
                            <h4>Contact Information</h4>
                            <p><strong>Email:</strong> @_model.Email</p>
                            <p><strong>Phone:</strong> @_model.PhoneNumber</p>
                        </div>

                        <div class="review-section">
                            <h4>Academic Information</h4>
                            <p><strong>School:</strong> @_model.SchoolName</p>
                            @if (_model.GradeYear.HasValue)
                            {
                                <p><strong>Grade:</strong> @_model.GradeYear</p>
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(_model.MotivationForTesting) || !string.IsNullOrEmpty(_model.CareerInterests))
                        {
                            <div class="review-section">
                                <h4>Survey Responses</h4>
                                @if (!string.IsNullOrEmpty(_model.MotivationForTesting))
                                {
                                    <p><strong>Motivation:</strong> @_model.MotivationForTesting</p>
                                }
                                @if (!string.IsNullOrEmpty(_model.CareerInterests))
                                {
                                    <p><strong>Career Interests:</strong> @_model.CareerInterests</p>
                                }
                                @if (!string.IsNullOrEmpty(_model.PreferredStudyField))
                                {
                                    <p><strong>Study Field:</strong> @_model.PreferredStudyField</p>
                                }
                            </div>
                        }

                        @if (_model.RequiresAccommodation)
                        {
                            <div class="review-section">
                                <h4>Special Accommodations</h4>
                                <p>@_model.AccommodationDetails</p>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(_submitError))
                        {
                            <FluentMessageBar Intent="MessageIntent.Error" Style="margin-top: 20px;">
                                @_submitError
                            </FluentMessageBar>
                        }

                        <div class="submit-section" style="margin-top: 30px;">
                            @if (_isSubmitting)
                            {
                                <FluentProgressRing Style="margin-bottom: 10px;" />
                                <p>Submitting your registration...</p>
                            }
                            else
                            {
                                <FluentButton Appearance="Appearance.Accent" 
                                            OnClick="@HandleSubmitAsync"
                                            Style="min-width: 200px;">
                                    <FluentIcon Value="@(new Icons.Regular.Size20.CheckmarkCircle())" Slot="start" />
                                    Complete Registration
                                </FluentButton>
                            }
                        </div>
                    </div>
                </FluentWizardStep>
            </FluentWizard>
        }
        else
        {
            <!-- Success Message -->
            <div class="success-content">
                <FluentIcon Value="@(new Icons.Regular.Size48.CheckmarkCircle())" Color="Color.Success" />
                <h2>Registration Successful!</h2>
                <p class="success-message">
                    Congratulations! Your registration has been completed successfully.
                </p>
                
                <div class="nbt-number-display">
                    <h3>Your NBT Number</h3>
                    <div class="nbt-number">@_generatedNBTNumber</div>
                    <p class="nbt-info">
                        Please save this number. You will need it for all future interactions with the NBT system.
                    </p>
                </div>

                <FluentMessageBar Intent="MessageIntent.Info" Style="margin-top: 20px;">
                    A confirmation email has been sent to @_model.Email with your NBT number and next steps.
                </FluentMessageBar>

                <div class="action-buttons">
                    <FluentButton Appearance="Appearance.Accent" 
                                OnClick="@(() => Navigation.NavigateTo("/login"))">
                        Proceed to Login
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Neutral" 
                                OnClick="@(() => Navigation.NavigateTo("/"))">
                        Return to Home
                    </FluentButton>
                </div>
            </div>
        }
    </FluentCard>
</div>

@code {
    private FluentWizard? _wizard;
    private RegistrationFormModel _model = new();
    private int _currentStepIndex = 0;
    private bool _registrationComplete = false;
    private bool _isSubmitting = false;
    private string? _submitError;
    private string? _generatedNBTNumber;
    private string? _idValidationMessage;
    private bool _idValidationError = false;
    private bool _dobExtractedFromID = false;
    private bool _genderExtractedFromID = false;
    private string? _step1ValidationMessage;
    private string? _step2ValidationMessage;

    private readonly List<string> _idTypes = new() { "SA_ID", "FOREIGN_ID", "PASSPORT" };
    private readonly List<string> _genderOptions = new() { "Male", "Female", "Other" };
    private readonly List<string> _ethnicityOptions = new() 
    { 
        "Black African", "Coloured", "Indian/Asian", "White", "Other", "Prefer not to say" 
    };
    private readonly List<string> _provinces = new()
    {
        "Eastern Cape", "Free State", "Gauteng", "KwaZulu-Natal",
        "Limpopo", "Mpumalanga", "Northern Cape", "North West", "Western Cape"
    };

    protected override void OnInitialized()
    {
        _model.Country = "South Africa";
        _model.IDType = "SA_ID"; // Default to SA ID
        _currentStepIndex = 0; // Start at first step
    }

    private async Task OnStepChangeAsync(FluentWizardStepChangeEventArgs args)
    {
        // Validate current step before moving forward
        if (args.TargetIndex > args.OldIndex)
        {
            var (isValid, errorMessage) = await ValidateCurrentStepWithMessageAsync(args.OldIndex);
            if (!isValid)
            {
                args.IsCancelled = true;
                
                // Set step-specific validation message
                if (args.OldIndex == 0)
                {
                    _step1ValidationMessage = errorMessage;
                }
                else if (args.OldIndex == 1)
                {
                    _step2ValidationMessage = errorMessage;
                }
                
                StateHasChanged();
                return;
            }
        }
        
        // Clear errors when successfully moving
        _step1ValidationMessage = null;
        _step2ValidationMessage = null;
        _submitError = null;
    }

    private async Task<bool> ValidateCurrentStepAsync(int stepIndex)
    {
        return stepIndex switch
        {
            0 => await ValidateStep1Async(),
            1 => await ValidateStep2Async(),
            2 => true, // Review step
            _ => true
        };
    }

    private async Task<(bool isValid, string? errorMessage)> ValidateCurrentStepWithMessageAsync(int stepIndex)
    {
        return stepIndex switch
        {
            0 => await ValidateStep1WithMessageAsync(),
            1 => await ValidateStep2WithMessageAsync(),
            2 => (true, null), // Review step
            _ => (true, null)
        };
    }

    private string GetIDTypeLabel(string idType)
    {
        return idType switch
        {
            "SA_ID" => "South African ID",
            "FOREIGN_ID" => "Foreign ID",
            "PASSPORT" => "Passport",
            _ => idType
        };
    }

    private string GetIDPlaceholder(string idType)
    {
        return idType switch
        {
            "SA_ID" => "13-digit SA ID Number",
            "FOREIGN_ID" => "Foreign ID Number",
            "PASSPORT" => "Passport Number",
            _ => "Enter ID Number"
        };
    }

    private async Task OnIDNumberChangedAsync()
    {
        var idNumber = _model.IDNumber ?? string.Empty;
        
        if (string.IsNullOrWhiteSpace(idNumber))
        {
            _idValidationMessage = null;
            _dobExtractedFromID = false;
            _genderExtractedFromID = false;
            StateHasChanged();
            return;
        }

        // Extract DOB and Gender from SA ID
        if (_model.IDType == "SA_ID" && idNumber.Length == 13 && idNumber.All(char.IsDigit))
        {
            ExtractDataFromSAID(idNumber);
        }
        else
        {
            _dobExtractedFromID = false;
            _genderExtractedFromID = false;
        }

        // Validate format
        var isValid = await RegistrationService.ValidateIDNumberAsync(idNumber, _model.IDType);
        if (!isValid)
        {
            _idValidationMessage = _model.IDType == "SA_ID" 
                ? "Invalid SA ID number format or checksum" 
                : "ID number must be between 6 and 20 characters";
            _idValidationError = true;
            StateHasChanged();
            return;
        }

        // Check for duplicates
        var isDuplicate = await RegistrationService.CheckDuplicateAsync(idNumber, _model.IDType);
        if (isDuplicate)
        {
            _idValidationMessage = "This ID number is already registered in the system";
            _idValidationError = true;
        }
        else
        {
            _idValidationMessage = "ID number is valid and available";
            _idValidationError = false;
        }
        StateHasChanged();
    }

    private void ExtractDataFromSAID(string idNumber)
    {
        try
        {
            // Extract date of birth (first 6 digits: YYMMDD)
            var year = int.Parse(idNumber.Substring(0, 2));
            var month = int.Parse(idNumber.Substring(2, 2));
            var day = int.Parse(idNumber.Substring(4, 2));
            
            // Determine century (assume IDs with year > current year's last 2 digits are from 1900s)
            var currentYearLastTwo = DateTime.Now.Year % 100;
            var century = year > currentYearLastTwo ? 1900 : 2000;
            var fullYear = century + year;
            
            _model.DateOfBirth = new DateTime(fullYear, month, day);
            _dobExtractedFromID = true;
            
            // Extract gender (7th digit: 0-4 = Female, 5-9 = Male)
            var genderDigit = int.Parse(idNumber.Substring(6, 1));
            _model.Gender = genderDigit < 5 ? "Female" : "Male";
            _genderExtractedFromID = true;
        }
        catch
        {
            _dobExtractedFromID = false;
            _genderExtractedFromID = false;
        }
    }

    private async Task HandleSubmitAsync()
    {
        // Validate all required fields
        if (!ValidateRegistrationModel())
        {
            _submitError = "Please fill in all required fields.";
            StateHasChanged();
            return;
        }

        _isSubmitting = true;
        _submitError = null;
        StateHasChanged();

        try
        {
            var result = await RegistrationService.RegisterStudentAsync(_model);
            
            if (result.Success)
            {
                _generatedNBTNumber = result.NBTNumber;
                _registrationComplete = true;
            }
            else
            {
                _submitError = result.ErrorMessage ?? "Registration failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _submitError = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

    private bool ValidateRegistrationModel()
    {
        // Validate required fields
        if (string.IsNullOrWhiteSpace(_model.FirstName) ||
            string.IsNullOrWhiteSpace(_model.LastName) ||
            string.IsNullOrWhiteSpace(_model.IDNumber) ||
            string.IsNullOrWhiteSpace(_model.Email) ||
            string.IsNullOrWhiteSpace(_model.PhoneNumber) ||
            string.IsNullOrWhiteSpace(_model.SchoolName) ||
            string.IsNullOrWhiteSpace(_model.Gender) ||
            string.IsNullOrWhiteSpace(_model.Ethnicity) ||
            !_model.DateOfBirth.HasValue)
        {
            return false;
        }

        // Validate foreign ID specific fields
        if ((_model.IDType == "FOREIGN_ID" || _model.IDType == "PASSPORT") &&
            (string.IsNullOrWhiteSpace(_model.Nationality) || string.IsNullOrWhiteSpace(_model.CountryOfOrigin)))
        {
            return false;
        }

        // Validate accommodation details if required
        if (_model.RequiresAccommodation && string.IsNullOrWhiteSpace(_model.AccommodationDetails))
        {
            return false;
        }

        return true;
    }

    // Step validation methods - synchronous for real-time UI updates
    private bool IsStep1Valid()
    {
        // Required fields for step 1 (Personal & Contact)
        if (string.IsNullOrWhiteSpace(_model.IDNumber) ||
            string.IsNullOrWhiteSpace(_model.FirstName) ||
            string.IsNullOrWhiteSpace(_model.LastName) ||
            string.IsNullOrWhiteSpace(_model.Email) ||
            string.IsNullOrWhiteSpace(_model.PhoneNumber) ||
            string.IsNullOrWhiteSpace(_model.Gender) ||
            string.IsNullOrWhiteSpace(_model.Ethnicity) ||
            !_model.DateOfBirth.HasValue)
        {
            return false;
        }

        // Foreign ID validation
        if ((_model.IDType == "FOREIGN_ID" || _model.IDType == "PASSPORT") &&
            (string.IsNullOrWhiteSpace(_model.Nationality) || string.IsNullOrWhiteSpace(_model.CountryOfOrigin)))
        {
            return false;
        }

        // Must not have validation errors
        if (_idValidationError)
        {
            return false;
        }

        return true;
    }

    private Task<bool> ValidateStep1Async()
    {
        return Task.FromResult(IsStep1Valid());
    }

    private bool IsStep2Valid()
    {
        // Required fields for step 2 (Academic & Survey)
        // School name is required, survey questions are optional
        if (string.IsNullOrWhiteSpace(_model.SchoolName))
        {
            return false;
        }

        // If accommodation is required, details must be provided
        if (_model.RequiresAccommodation && string.IsNullOrWhiteSpace(_model.AccommodationDetails))
        {
            return false;
        }

        return true;
    }

    private Task<bool> ValidateStep2Async()
    {
        return Task.FromResult(IsStep2Valid());
    }

    private Task<(bool, string?)> ValidateStep1WithMessageAsync()
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(_model.IDNumber))
            errors.Add("ID Number is required");
        if (string.IsNullOrWhiteSpace(_model.FirstName))
            errors.Add("First Name is required");
        if (string.IsNullOrWhiteSpace(_model.LastName))
            errors.Add("Last Name is required");
        if (!_model.DateOfBirth.HasValue)
            errors.Add("Date of Birth is required");
        if (string.IsNullOrWhiteSpace(_model.Gender))
            errors.Add("Gender is required");
        if (string.IsNullOrWhiteSpace(_model.Ethnicity))
            errors.Add("Ethnicity is required");
        if (string.IsNullOrWhiteSpace(_model.Email))
            errors.Add("Email is required");
        if (string.IsNullOrWhiteSpace(_model.PhoneNumber))
            errors.Add("Phone Number is required");

        if ((_model.IDType == "FOREIGN_ID" || _model.IDType == "PASSPORT"))
        {
            if (string.IsNullOrWhiteSpace(_model.Nationality))
                errors.Add("Nationality is required for foreign IDs");
            if (string.IsNullOrWhiteSpace(_model.CountryOfOrigin))
                errors.Add("Country of Origin is required for foreign IDs");
        }

        if (_idValidationError)
            errors.Add("ID Number has validation errors");

        if (errors.Any())
        {
            return Task.FromResult((false, string.Join("; ", errors)));
        }

        return Task.FromResult((true, (string?)null));
    }

    private Task<(bool, string?)> ValidateStep2WithMessageAsync()
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(_model.SchoolName))
            errors.Add("School Name is required");

        if (_model.RequiresAccommodation && string.IsNullOrWhiteSpace(_model.AccommodationDetails))
            errors.Add("Accommodation details are required when special accommodations are requested");

        if (errors.Any())
        {
            return Task.FromResult((false, string.Join("; ", errors)));
        }

        return Task.FromResult((true, (string?)null));
    }

    private RenderFragment<FluentWizard> CustomButtonTemplate => wizard => __builder =>
    {
        var canMoveNext = _currentStepIndex == 0 ? IsStep1Valid() : 
                         _currentStepIndex == 1 ? IsStep2Valid() : 
                         true;

        <div class="wizard-button-container" style="display: flex; gap: 10px; margin-top: 20px;">
            @if (_currentStepIndex > 0)
            {
                <FluentButton Appearance="Appearance.Neutral"
                            OnClick="@(() => wizard.GoToPreviousAsync())">
                    Previous
                </FluentButton>
            }
            
            @if (_currentStepIndex < 2)
            {
                <FluentButton Appearance="Appearance.Accent"
                            Disabled="@(!canMoveNext)"
                            OnClick="@(() => wizard.GoToNextAsync())">
                    Next
                </FluentButton>
            }
            else
            {
                <FluentButton Appearance="Appearance.Accent"
                            Disabled="@(!canMoveNext)"
                            OnClick="@HandleSubmitAsync">
                    <FluentIcon Value="@(new Icons.Regular.Size20.CheckmarkCircle())" Slot="start" />
                    Complete Registration
                </FluentButton>
            }
        </div>
    };
}
