@using NBT.Application.Staff.DTOs
@using Microsoft.FluentUI.AspNetCore.Components
@inject IStaffService StaffService

<FluentDialogBody>
    <FluentStack Orientation="Orientation.Vertical">
        <FluentLabel>Enter a new password for this staff member:</FluentLabel>

        <FluentTextField @bind-Value="@newPassword" 
                        Label="New Password" 
                        TextFieldType="TextFieldType.Password"
                        Required="true"
                        Style="width: 100%;" />

        <FluentTextField @bind-Value="@confirmPassword" 
                        Label="Confirm Password" 
                        TextFieldType="TextFieldType.Password"
                        Required="true"
                        Style="width: 100%;" />

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Error">
                @errorMessage
            </FluentMessageBar>
        }
    </FluentStack>
</FluentDialogBody>

<FluentDialogFooter>
    <FluentButton Appearance="Appearance.Accent" 
                 OnClick="@SaveAsync"
                 Disabled="@isSaving">
        @(isSaving ? "Resetting..." : "Reset Password")
    </FluentButton>
    <FluentButton Appearance="Appearance.Neutral" 
                 OnClick="@CancelAsync">
        Cancel
    </FluentButton>
</FluentDialogFooter>

@code {
    [CascadingParameter]
    public FluentDialog? Dialog { get; set; }

    [Parameter]
    public StaffDto Staff { get; set; } = new();

    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    private bool isSaving = false;
    private string errorMessage = string.Empty;

    private async Task SaveAsync()
    {
        errorMessage = string.Empty;
        
        if (string.IsNullOrWhiteSpace(newPassword) || string.IsNullOrWhiteSpace(confirmPassword))
        {
            errorMessage = "Please enter and confirm the new password.";
            return;
        }

        if (newPassword != confirmPassword)
        {
            errorMessage = "Passwords do not match.";
            return;
        }

        if (newPassword.Length < 8)
        {
            errorMessage = "Password must be at least 8 characters long.";
            return;
        }

        isSaving = true;
        try
        {
            var success = await StaffService.ResetPasswordAsync(Staff.Id, newPassword);
            if (success)
            {
                await Dialog!.CloseAsync(true);
            }
            else
            {
                errorMessage = "Failed to reset password. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task CancelAsync()
    {
        await Dialog!.CancelAsync();
    }
}
